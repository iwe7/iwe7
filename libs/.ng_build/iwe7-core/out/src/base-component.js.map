{"version":3,"file":"base-component.js","sourceRoot":"","sources":["base-component.ts"],"names":[],"mappings":"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","sourcesContent":["// 给予rxjs设计的组件\nimport {\n  Input,\n  OnChanges,\n  SimpleChanges,\n  ChangeDetectorRef,\n  OnInit,\n  OnDestroy,\n  ɵisObservable,\n  Injector,\n  HostBinding,\n  Output,\n  EventEmitter\n} from '@angular/core';\nimport {\n  Observable,\n  merge,\n  Subscription,\n  BehaviorSubject,\n  Subject\n} from 'rxjs';\nimport {\n  first,\n  filter,\n  takeWhile,\n  distinctUntilChanged,\n  scan,\n  takeUntil,\n  tap,\n  pairwise,\n  map,\n  switchMap\n} from 'rxjs/operators';\nimport { isEqual } from 'underscore';\nimport { CacheMemoryService, SubscribersService } from 'iwe7/cache';\nexport abstract class Iwe7Base<T> implements OnChanges, OnInit, OnDestroy {\n  // 保存最新值\n  public _props: T;\n\n  // 保存关联组件\n  public instance: Iwe7Base<T>;\n  @Input() props: BehaviorSubject<T> = new BehaviorSubject({} as T);\n  // 监听组件事件流\n  __events: Subject<{\n    type: string;\n    selector?: string;\n    data?: any;\n  }> = new Subject();\n\n  @Output() eventsEmit: EventEmitter<any> = new EventEmitter();\n  // 需要注销开关\n  private needDestory: boolean = false;\n  public cd: ChangeDetectorRef;\n  public memory: CacheMemoryService<any>;\n  // 订阅控制器\n  public __subscribers: SubscribersService;\n  // 系统生成编号\n  @HostBinding('attr.data-id') __id: string;\n\n  constructor(public injector: Injector) {\n    this.cd = this.injector.get(ChangeDetectorRef);\n    this.memory = this.injector.get(CacheMemoryService);\n    this.__subscribers = this.injector.get(SubscribersService);\n    this.__events.subscribe(res => {\n      this.eventsEmit.emit(res);\n    });\n  }\n\n  ngOnChanges(changes: SimpleChanges) {\n    if ('props' in changes) {\n      if (!changes['props'].isFirstChange) {\n        this.__propsHandler();\n      }\n    }\n  }\n  /**\n   * 注销\n   */\n  ngOnDestroy() {\n    this.__subscribers.destory(this.__id);\n    this.__sub.unsubscribe();\n    this.needDestory = true;\n  }\n\n  ngOnInit() {\n    this.__propsHandler();\n  }\n\n  setProps(props: BehaviorSubject<T>) {\n    if (!ɵisObservable(props)) {\n      props = new BehaviorSubject(props);\n    }\n    this.props = this.props.pipe<T>(switchMap(res => props)) as BehaviorSubject<\n      T\n    >;\n    this.__propsHandler();\n  }\n\n  setData(res: T) {\n    this.props.next({ ...(this._props as any), ...(res as any) });\n  }\n\n  __sub: Subscription;\n  __propsHandler() {\n    this.__sub = this.props.subscribe(res => {\n      res = res || ({} as T);\n      this._props = res;\n      if ('data-id' in res) {\n      } else {\n        res['data-id'] = this.__getUuid();\n      }\n      this.__id = res['data-id'];\n      this.memory.set(this.__id, this._props);\n      this.onPropsChange(res);\n    });\n  }\n\n  getProps() {\n    return this._props;\n  }\n\n  __addSub(sub: Subscription) {\n    this.__subscribers.addSub(this.__id, sub);\n  }\n\n  __getUuid() {\n    let d = new Date().getTime();\n    let uuid = 'meepo.yxxxxxxxxxxxxxxxyxxxxxxxxxxxxxxx'.replace(/[xy]/g, c => {\n      let r = ((d + Math.random() * 16) % 16) | 0;\n      d = Math.floor(d / 16);\n      return (c === 'x' ? r : (r & 0x3) | 0x8).toString(16);\n    });\n    return uuid;\n  }\n\n  public onPropsChange(res: T): void {\n    this.cd.detectChanges();\n  }\n}\n"]}